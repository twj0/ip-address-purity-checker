<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPåœ°å€çº¯å‡€åº¦æ£€æŸ¥å™¨ - Cloudflare Pages</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .result.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }
        
        .feature {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .feature-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .api-docs {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .api-endpoint {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }

        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e1e5e9;
            margin-bottom: 0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #667eea;
            background: #f8f9fa;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            margin-top: 0;
        }

        /* æ–‡æœ¬åŸŸæ ·å¼ */
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        /* å°æ–‡æœ¬æ ·å¼ */
        small {
            color: #666;
            font-size: 12px;
        }

        small a {
            color: #667eea;
            text-decoration: none;
        }

        small a:hover {
            text-decoration: underline;
        }

        /* å¤é€‰æ¡†æ ·å¼ */
        .input-group label input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            height: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        /* ç»“æœè¡¨æ ¼æ ·å¼ */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .results-table th,
        .results-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }

        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .pure-yes {
            color: #28a745;
            font-weight: 600;
        }

        .pure-no {
            color: #dc3545;
            font-weight: 600;
        }

        /* ä¸‹è½½æŒ‰é’®æ ·å¼ */
        .download-btn {
            background: #28a745;
            margin-left: 10px;
        }

        .download-btn:hover {
            background: #218838;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }

            .tab-btn {
                text-align: left;
                border-bottom: 1px solid #e1e5e9;
                border-right: none;
            }

            .tab-btn.active {
                border-bottom-color: #e1e5e9;
                border-left: 3px solid #667eea;
            }

            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” IPåœ°å€çº¯å‡€åº¦æ£€æŸ¥å™¨</h1>
            <p>åŸºäºIPinfo.ioçš„é«˜ç²¾åº¦IPçº¯å‡€åº¦æ£€æµ‹æœåŠ¡</p>
        </div>
        
        <!-- å¯¼èˆªæ ‡ç­¾ -->
        <div class="card">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('single')">å•IPæ£€æµ‹</button>
                <button class="tab-btn" onclick="switchTab('batch')">æ‰¹é‡æ£€æµ‹</button>
                <button class="tab-btn" onclick="switchTab('subscription')">è®¢é˜…æ£€æµ‹</button>
            </div>
        </div>

        <!-- å•IPæ£€æµ‹ -->
        <div class="card tab-content" id="single-tab">
            <h2>ğŸ” å•IPæ£€æµ‹</h2>
            <div class="input-group">
                <label for="ipInput">è¾“å…¥IPåœ°å€ï¼š</label>
                <input type="text" id="ipInput" placeholder="ä¾‹å¦‚ï¼š8.8.8.8" />
            </div>
            <div class="input-group">
                <label for="proxycheckKeyInput">ProxyCheck.io API Keyï¼ˆæ¨èï¼‰ï¼š</label>
                <input type="password" id="proxycheckKeyInput" placeholder="ä¸“ä¸šä»£ç†æ£€æµ‹APIå¯†é’¥ï¼Œ1000æ¬¡/å¤©å…è´¹" />
                <small>è·å–å…è´¹API Keyï¼š<a href="https://proxycheck.io/api/" target="_blank">https://proxycheck.io/api/</a></small>
            </div>
            <div class="input-group">
                <label for="tokenInput">IPinfo.io Tokenï¼ˆå¤‡ç”¨ï¼‰ï¼š</label>
                <input type="password" id="tokenInput" placeholder="å¤‡ç”¨API token" />
                <small>è·å–å…è´¹tokenï¼š<a href="https://ipinfo.io/signup" target="_blank">https://ipinfo.io/signup</a></small>
            </div>
            <button class="btn" onclick="checkSingleIP()">æ£€æŸ¥çº¯å‡€åº¦</button>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨æ£€æŸ¥ä¸­...</p>
            </div>

            <div class="result" id="result"></div>
        </div>

        <!-- æ‰¹é‡IPæ£€æµ‹ -->
        <div class="card tab-content" id="batch-tab" style="display: none;">
            <h2>ğŸ“‹ æ‰¹é‡IPæ£€æµ‹</h2>
            <div class="input-group">
                <label for="batchIpInput">è¾“å…¥å¤šä¸ªIPåœ°å€ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š</label>
                <textarea id="batchIpInput" rows="8" placeholder="8.8.8.8&#10;1.1.1.1&#10;114.114.114.114"></textarea>
            </div>
            <div class="input-group">
                <label for="batchProxycheckKeyInput">ProxyCheck.io API Keyï¼ˆæ¨èï¼‰ï¼š</label>
                <input type="password" id="batchProxycheckKeyInput" placeholder="ä¸“ä¸šä»£ç†æ£€æµ‹APIå¯†é’¥" />
            </div>
            <div class="input-group">
                <label for="batchTokenInput">IPinfo.io Tokenï¼ˆå¤‡ç”¨ï¼‰ï¼š</label>
                <input type="password" id="batchTokenInput" placeholder="å¤‡ç”¨API token" />
            </div>
            <button class="btn" onclick="checkBatchIPs()">æ‰¹é‡æ£€æµ‹</button>

            <div class="loading" id="batchLoading">
                <div class="spinner"></div>
                <p>æ­£åœ¨æ‰¹é‡æ£€æµ‹ä¸­...</p>
            </div>

            <div class="result" id="batchResult"></div>
        </div>

        <!-- è®¢é˜…æ£€æµ‹ -->
        <div class="card tab-content" id="subscription-tab" style="display: none;">
            <h2>ğŸ“¡ è®¢é˜…é“¾æ¥æ£€æµ‹</h2>
            <div class="input-group">
                <label for="subscriptionInput">è¾“å…¥è®¢é˜…é“¾æ¥ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š</label>
                <textarea id="subscriptionInput" rows="6" placeholder="https://example.com/subscription1&#10;https://example.com/subscription2"></textarea>
                <small>æ”¯æŒæ ¼å¼ï¼švmessã€vlessã€trojanã€ssã€ssrã€clash yamlç­‰</small>
            </div>
            <div class="input-group">
                <label for="subProxycheckKeyInput">ProxyCheck.io API Keyï¼ˆæ¨èï¼‰ï¼š</label>
                <input type="password" id="subProxycheckKeyInput" placeholder="ä¸“ä¸šä»£ç†æ£€æµ‹APIå¯†é’¥" />
            </div>
            <div class="input-group">
                <label for="subTokenInput">IPinfo.io Tokenï¼ˆå¤‡ç”¨ï¼‰ï¼š</label>
                <input type="password" id="subTokenInput" placeholder="å¤‡ç”¨API token" />
            </div>
            <div class="input-group">
                <label>
                    <input type="checkbox" id="generateClash"> ç”ŸæˆClashé…ç½®æ–‡ä»¶
                </label>
            </div>
            <button class="btn" onclick="checkSubscriptions()">å¼€å§‹æ£€æµ‹</button>

            <div class="loading" id="subLoading">
                <div class="spinner"></div>
                <p>æ­£åœ¨å¤„ç†è®¢é˜…é“¾æ¥...</p>
            </div>

            <div class="result" id="subResult"></div>
        </div>
        
        <div class="features">
            <div class="feature">
                <div class="feature-icon">âš¡</div>
                <h3>é«˜é€Ÿæ£€æµ‹</h3>
                <p>åŸºäºCloudflare Pageså…¨çƒè¾¹ç¼˜ç½‘ç»œï¼Œæ¯«ç§’çº§å“åº”</p>
            </div>
            <div class="feature">
                <div class="feature-icon">ğŸ¯</div>
                <h3>ä¸“ä¸šæ£€æµ‹</h3>
                <p>é›†æˆProxyCheck.ioä¸“ä¸šä»£ç†æ£€æµ‹ï¼Œæä¾›0-100é£é™©è¯„åˆ†</p>
            </div>
            <div class="feature">
                <div class="feature-icon">ğŸ”„</div>
                <h3>å®šæ—¶ä»»åŠ¡</h3>
                <p>Cloudflare Workersæ¯æ—¥è‡ªåŠ¨æ£€æµ‹ï¼Œç¡®ä¿æ•°æ®æ—¶æ•ˆæ€§</p>
            </div>
        </div>
        
        <div class="card">
            <h2>APIæ–‡æ¡£</h2>
            <div class="api-docs">
                <h3>å¯ç”¨æ¥å£</h3>
                <div class="api-endpoint">
                    GET /api/check-ip?ip={ip_address}
                </div>
                <p>æ£€æŸ¥å•ä¸ªIPåœ°å€çš„çº¯å‡€åº¦</p>
                
                <div class="api-endpoint">
                    GET /api/scheduled-check
                </div>
                <p>æ‰§è¡Œå®Œæ•´çš„è®¢é˜…IPæ£€æŸ¥ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰</p>
                
                <h3>å“åº”æ ¼å¼</h3>
                <pre>{
  "ip": "8.8.8.8",
  "country": "US",
  "city": "Mountain View",
  "org": "AS15169 Google LLC",
  "isPure": false,
  "privacy": {
    "hosting": true,
    "vpn": false,
    "proxy": false,
    "tor": false
  },
  "timestamp": "2024-01-01T00:00:00Z"
}</pre>
            </div>
        </div>
    </div>
    
    <script>
        // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.style.display = 'none');

            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„activeç±»
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => btn.classList.remove('active'));

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            document.getElementById(`${tabName}-tab`).style.display = 'block';

            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾æŒ‰é’®
            event.target.classList.add('active');
        }

        // å•IPæ£€æµ‹åŠŸèƒ½
        async function checkSingleIP() {
            const ipInput = document.getElementById('ipInput');
            const proxycheckKeyInput = document.getElementById('proxycheckKeyInput');
            const tokenInput = document.getElementById('tokenInput');
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');
            const btn = document.querySelector('#single-tab .btn');

            const ip = ipInput.value.trim();
            if (!ip) {
                showResult('è¯·è¾“å…¥æœ‰æ•ˆçš„IPåœ°å€', 'error', 'result');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loading.style.display = 'block';
            result.style.display = 'none';
            btn.disabled = true;

            try {
                let url = `/api/check-ip?ip=${encodeURIComponent(ip)}`;
                const headers = {};

                // ä¼˜å…ˆä½¿ç”¨ProxyCheck.io APIå¯†é’¥
                const proxycheckKey = proxycheckKeyInput.value.trim();
                if (proxycheckKey) {
                    headers['X-ProxyCheck-Key'] = proxycheckKey;
                }

                // å¤‡ç”¨IPinfo.io token
                const token = tokenInput.value.trim();
                if (token) {
                    headers['X-IPInfo-Token'] = token;
                }

                const response = await fetch(url, { headers });
                const data = await response.json();

                if (response.ok) {
                    displayIPResult(data, 'result');
                } else {
                    showResult(`é”™è¯¯: ${data.error}`, 'error', 'result');
                }
            } catch (error) {
                showResult(`ç½‘ç»œé”™è¯¯: ${error.message}`, 'error', 'result');
            } finally {
                loading.style.display = 'none';
                btn.disabled = false;
            }
        }
        
        // æ‰¹é‡IPæ£€æµ‹åŠŸèƒ½
        async function checkBatchIPs() {
            const batchIpInput = document.getElementById('batchIpInput');
            const batchProxycheckKeyInput = document.getElementById('batchProxycheckKeyInput');
            const batchTokenInput = document.getElementById('batchTokenInput');
            const batchLoading = document.getElementById('batchLoading');
            const batchResult = document.getElementById('batchResult');
            const btn = document.querySelector('#batch-tab .btn');

            const ipsText = batchIpInput.value.trim();
            if (!ipsText) {
                showResult('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªIPåœ°å€', 'error', 'batchResult');
                return;
            }

            const ips = ipsText.split('\n').map(ip => ip.trim()).filter(ip => ip);
            if (ips.length === 0) {
                showResult('è¯·è¾“å…¥æœ‰æ•ˆçš„IPåœ°å€', 'error', 'batchResult');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            batchLoading.style.display = 'block';
            batchResult.style.display = 'none';
            btn.disabled = true;

            const results = [];
            const proxycheckKey = batchProxycheckKeyInput.value.trim();
            const token = batchTokenInput.value.trim();

            try {
                // åˆ›å»ºè¿›åº¦æ˜¾ç¤º
                const progressHTML = `
                    <div class="progress-container">
                        <div class="progress-bar" id="batchProgress">0%</div>
                    </div>
                    <p>æ­£åœ¨æ£€æµ‹ ${ips.length} ä¸ªIPåœ°å€...</p>
                `;
                batchLoading.innerHTML = progressHTML;

                for (let i = 0; i < ips.length; i++) {
                    const ip = ips[i];
                    try {
                        const headers = {};
                        if (proxycheckKey) {
                            headers['X-ProxyCheck-Key'] = proxycheckKey;
                        }
                        if (token) {
                            headers['X-IPInfo-Token'] = token;
                        }

                        const response = await fetch(`/api/check-ip?ip=${encodeURIComponent(ip)}`, { headers });
                        const data = await response.json();

                        if (response.ok) {
                            results.push(data);
                        } else {
                            results.push({ ip, error: data.error, isPure: false });
                        }
                    } catch (error) {
                        results.push({ ip, error: error.message, isPure: false });
                    }

                    // æ›´æ–°è¿›åº¦
                    const progress = Math.round(((i + 1) / ips.length) * 100);
                    const progressBar = document.getElementById('batchProgress');
                    if (progressBar) {
                        progressBar.style.width = `${progress}%`;
                        progressBar.textContent = `${progress}%`;
                    }

                    // æ·»åŠ å»¶è¿Ÿé¿å…è¿‡å¿«è¯·æ±‚
                    if (i < ips.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }

                displayBatchResults(results);

            } catch (error) {
                showResult(`æ‰¹é‡æ£€æµ‹é”™è¯¯: ${error.message}`, 'error', 'batchResult');
            } finally {
                batchLoading.style.display = 'none';
                btn.disabled = false;
            }
        }

        // æ˜¾ç¤ºæ‰¹é‡æ£€æµ‹ç»“æœ
        function displayBatchResults(results) {
            const pureCount = results.filter(r => r.isPure).length;
            const totalCount = results.length;
            const purityRate = ((pureCount / totalCount) * 100).toFixed(1);

            let tableHTML = `
                <h3>æ‰¹é‡æ£€æµ‹å®Œæˆ</h3>
                <p><strong>æ€»è®¡:</strong> ${totalCount} ä¸ªIP | <strong>çº¯å‡€:</strong> ${pureCount} ä¸ª | <strong>çº¯å‡€ç‡:</strong> ${purityRate}%</p>
                <button class="btn download-btn" onclick="downloadCSV()">ä¸‹è½½CSVæŠ¥å‘Š</button>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>IPåœ°å€</th>
                            <th>çº¯å‡€åº¦</th>
                            <th>å›½å®¶</th>
                            <th>åŸå¸‚</th>
                            <th>ç»„ç»‡</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            results.forEach(result => {
                const purityText = result.isPure ? 'çº¯å‡€' : 'éçº¯å‡€';
                const purityClass = result.isPure ? 'pure-yes' : 'pure-no';

                tableHTML += `
                    <tr>
                        <td>${result.ip}</td>
                        <td class="${purityClass}">${purityText}</td>
                        <td>${result.country || 'N/A'}</td>
                        <td>${result.city || 'N/A'}</td>
                        <td>${result.org || result.error || 'N/A'}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';

            // å­˜å‚¨ç»“æœä¾›ä¸‹è½½ä½¿ç”¨
            window.batchResults = results;

            showResult(tableHTML, 'success', 'batchResult');
        }
        
        // è®¢é˜…æ£€æµ‹åŠŸèƒ½
        async function checkSubscriptions() {
            const subscriptionInput = document.getElementById('subscriptionInput');
            const subProxycheckKeyInput = document.getElementById('subProxycheckKeyInput');
            const subTokenInput = document.getElementById('subTokenInput');
            const generateClash = document.getElementById('generateClash');
            const subLoading = document.getElementById('subLoading');
            const subResult = document.getElementById('subResult');
            const btn = document.querySelector('#subscription-tab .btn');

            const subscriptionsText = subscriptionInput.value.trim();
            if (!subscriptionsText) {
                showResult('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªè®¢é˜…é“¾æ¥', 'error', 'subResult');
                return;
            }

            const subscriptions = subscriptionsText.split('\n').map(url => url.trim()).filter(url => url);
            if (subscriptions.length === 0) {
                showResult('è¯·è¾“å…¥æœ‰æ•ˆçš„è®¢é˜…é“¾æ¥', 'error', 'subResult');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            subLoading.style.display = 'block';
            subResult.style.display = 'none';
            btn.disabled = true;

            try {
                const proxycheckKey = subProxycheckKeyInput.value.trim();
                const token = subTokenInput.value.trim();
                const headers = {};
                if (proxycheckKey) {
                    headers['X-ProxyCheck-Key'] = proxycheckKey;
                }
                if (token) {
                    headers['X-IPInfo-Token'] = token;
                }

                // æ„å»ºè¯·æ±‚å‚æ•°
                const params = new URLSearchParams();
                subscriptions.forEach(url => params.append('urls', url));
                if (generateClash.checked) {
                    params.append('generate_clash', 'true');
                }

                const response = await fetch('/api/check-subscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        ...headers
                    },
                    body: params
                });

                const data = await response.json();

                if (response.ok) {
                    displaySubscriptionResults(data);
                } else {
                    showResult(`è®¢é˜…æ£€æµ‹é”™è¯¯: ${data.error}`, 'error', 'subResult');
                }

            } catch (error) {
                showResult(`ç½‘ç»œé”™è¯¯: ${error.message}`, 'error', 'subResult');
            } finally {
                subLoading.style.display = 'none';
                btn.disabled = false;
            }
        }

        // æ˜¾ç¤ºè®¢é˜…æ£€æµ‹ç»“æœ
        function displaySubscriptionResults(data) {
            const { total, pure, nonPure, purityRate, results, clashConfig } = data;

            let resultHTML = `
                <h3>è®¢é˜…æ£€æµ‹å®Œæˆ</h3>
                <p><strong>æ€»èŠ‚ç‚¹æ•°:</strong> ${total} | <strong>çº¯å‡€èŠ‚ç‚¹:</strong> ${pure} | <strong>çº¯å‡€ç‡:</strong> ${purityRate}%</p>
                <button class="btn download-btn" onclick="downloadSubscriptionCSV()">ä¸‹è½½è¯¦ç»†æŠ¥å‘Š</button>
            `;

            if (clashConfig) {
                resultHTML += `<button class="btn download-btn" onclick="downloadClashConfig()">ä¸‹è½½Clashé…ç½®</button>`;
                window.clashConfig = clashConfig;
            }

            if (results && results.length > 0) {
                resultHTML += `
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>èŠ‚ç‚¹åç§°</th>
                                <th>IPåœ°å€</th>
                                <th>çº¯å‡€åº¦</th>
                                <th>å›½å®¶</th>
                                <th>ç»„ç»‡</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                results.slice(0, 50).forEach(result => { // åªæ˜¾ç¤ºå‰50ä¸ªç»“æœ
                    const purityText = result.isPure ? 'çº¯å‡€' : 'éçº¯å‡€';
                    const purityClass = result.isPure ? 'pure-yes' : 'pure-no';

                    resultHTML += `
                        <tr>
                            <td>${result.name || 'N/A'}</td>
                            <td>${result.ip}</td>
                            <td class="${purityClass}">${purityText}</td>
                            <td>${result.country || 'N/A'}</td>
                            <td>${result.org || 'N/A'}</td>
                        </tr>
                    `;
                });

                resultHTML += '</tbody></table>';

                if (results.length > 50) {
                    resultHTML += `<p><small>æ˜¾ç¤ºå‰50ä¸ªç»“æœï¼Œå®Œæ•´ç»“æœè¯·ä¸‹è½½æŠ¥å‘ŠæŸ¥çœ‹</small></p>`;
                }
            }

            // å­˜å‚¨ç»“æœä¾›ä¸‹è½½ä½¿ç”¨
            window.subscriptionResults = data;

            showResult(resultHTML, 'success', 'subResult');
        }

        // æ˜¾ç¤ºIPæ£€æµ‹ç»“æœ
        function displayIPResult(data, resultId) {
            const purityText = data.isPure ? 'âœ… çº¯å‡€IP' : 'âŒ éçº¯å‡€IP';
            const purityClass = data.isPure ? 'success' : 'warning';

            let detailInfo = '';

            // ProxyCheck.ioè¯¦ç»†ä¿¡æ¯
            if (data.provider === 'proxycheck.io') {
                detailInfo = `
                    <h4>ProxyCheck.io ä¸“ä¸šæ£€æµ‹ç»“æœï¼š</h4>
                    <ul>
                        <li><strong>é£é™©è¯„åˆ†:</strong> ${data.risk_score || 0}/100</li>
                        <li><strong>ä»£ç†æ£€æµ‹:</strong> ${data.is_proxy ? 'æ˜¯' : 'å¦'}</li>
                        <li><strong>ä»£ç†ç±»å‹:</strong> ${data.proxy_type || 'æ— '}</li>
                        <li><strong>æ‰˜ç®¡æœåŠ¡å™¨:</strong> ${data.privacy?.hosting ? 'æ˜¯' : 'å¦'}</li>
                        <li><strong>VPN:</strong> ${data.privacy?.vpn ? 'æ˜¯' : 'å¦'}</li>
                        <li><strong>ä»£ç†:</strong> ${data.privacy?.proxy ? 'æ˜¯' : 'å¦'}</li>
                        <li><strong>Tor:</strong> ${data.privacy?.tor ? 'æ˜¯' : 'å¦'}</li>
                    </ul>
                `;
            } else if (data.privacy) {
                // IPinfo.ioéšç§ä¿¡æ¯
                const privacy = data.privacy;
                detailInfo = `
                    <h4>IPinfo.io æ£€æµ‹ç»“æœï¼š</h4>
                    <ul>
                        <li><strong>æ‰˜ç®¡æœåŠ¡å™¨:</strong> ${privacy.hosting ? 'æ˜¯' : 'å¦'}</li>
                        <li><strong>VPN:</strong> ${privacy.vpn ? 'æ˜¯' : 'å¦'}</li>
                        <li><strong>ä»£ç†:</strong> ${privacy.proxy ? 'æ˜¯' : 'å¦'}</li>
                        <li><strong>Tor:</strong> ${privacy.tor ? 'æ˜¯' : 'å¦'}</li>
                    </ul>
                `;
            }

            const resultHTML = `
                <h3>${purityText}</h3>
                <p><strong>IP:</strong> ${data.ip}</p>
                <p><strong>ä½ç½®:</strong> ${data.city}, ${data.country}</p>
                <p><strong>ç»„ç»‡:</strong> ${data.org}</p>
                ${detailInfo}
                <p><small>æ£€æµ‹æ—¶é—´: ${new Date(data.timestamp || Date.now()).toLocaleString()}</small></p>
                <p><small>æ•°æ®æ¥æº: ${data.provider || 'ip-api.com'}</small></p>
            `;

            showResult(resultHTML, purityClass, resultId);
        }

        // é€šç”¨ç»“æœæ˜¾ç¤ºå‡½æ•°
        function showResult(message, type, resultId = 'result') {
            const result = document.getElementById(resultId);
            result.innerHTML = message;
            result.className = `result ${type}`;
            result.style.display = 'block';
        }
        // ä¸‹è½½CSVæŠ¥å‘ŠåŠŸèƒ½
        function downloadCSV() {
            if (!window.batchResults) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ•°æ®');
                return;
            }

            const headers = ['IPåœ°å€', 'çº¯å‡€åº¦', 'å›½å®¶', 'åŸå¸‚', 'ç»„ç»‡', 'æ£€æµ‹æ—¶é—´'];
            const csvContent = [
                headers.join(','),
                ...window.batchResults.map(result => [
                    result.ip,
                    result.isPure ? 'çº¯å‡€' : 'éçº¯å‡€',
                    result.country || '',
                    result.city || '',
                    `"${(result.org || '').replace(/"/g, '""')}"`,
                    result.timestamp || new Date().toISOString()
                ].join(','))
            ].join('\n');

            downloadFile(csvContent, 'ip-purity-report.csv', 'text/csv');
        }

        // ä¸‹è½½è®¢é˜…æ£€æµ‹CSVæŠ¥å‘Š
        function downloadSubscriptionCSV() {
            if (!window.subscriptionResults) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ•°æ®');
                return;
            }

            const { results } = window.subscriptionResults;
            const headers = ['èŠ‚ç‚¹åç§°', 'IPåœ°å€', 'çº¯å‡€åº¦', 'å›½å®¶', 'åŸå¸‚', 'ç»„ç»‡', 'æ£€æµ‹æ—¶é—´'];
            const csvContent = [
                headers.join(','),
                ...results.map(result => [
                    `"${(result.name || '').replace(/"/g, '""')}"`,
                    result.ip,
                    result.isPure ? 'çº¯å‡€' : 'éçº¯å‡€',
                    result.country || '',
                    result.city || '',
                    `"${(result.org || '').replace(/"/g, '""')}"`,
                    result.timestamp || new Date().toISOString()
                ].join(','))
            ].join('\n');

            downloadFile(csvContent, 'subscription-purity-report.csv', 'text/csv');
        }

        // ä¸‹è½½Clashé…ç½®æ–‡ä»¶
        function downloadClashConfig() {
            if (!window.clashConfig) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„Clashé…ç½®');
                return;
            }

            downloadFile(window.clashConfig, 'clash-pure-config.yml', 'text/yaml');
        }

        // é€šç”¨æ–‡ä»¶ä¸‹è½½å‡½æ•°
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // é”®ç›˜äº‹ä»¶æ”¯æŒ
        document.addEventListener('DOMContentLoaded', function() {
            // å•IPæ£€æµ‹å›è½¦é”®æ”¯æŒ
            const ipInput = document.getElementById('ipInput');
            if (ipInput) {
                ipInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkSingleIP();
                    }
                });
            }

            // æ‰¹é‡æ£€æµ‹Ctrl+Enteræ”¯æŒ
            const batchIpInput = document.getElementById('batchIpInput');
            if (batchIpInput) {
                batchIpInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        checkBatchIPs();
                    }
                });
            }

            // è®¢é˜…æ£€æµ‹Ctrl+Enteræ”¯æŒ
            const subscriptionInput = document.getElementById('subscriptionInput');
            if (subscriptionInput) {
                subscriptionInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        checkSubscriptions();
                    }
                });
            }
        });

        // è‡ªåŠ¨ä¿å­˜ç”¨æˆ·è¾“å…¥çš„APIå¯†é’¥ï¼ˆä»…åœ¨å½“å‰ä¼šè¯ï¼‰
        function saveTokenToSession() {
            const inputs = [
                { id: 'proxycheckKeyInput', key: 'proxycheck_key_0' },
                { id: 'tokenInput', key: 'ipinfo_token_0' },
                { id: 'batchProxycheckKeyInput', key: 'proxycheck_key_1' },
                { id: 'batchTokenInput', key: 'ipinfo_token_1' },
                { id: 'subProxycheckKeyInput', key: 'proxycheck_key_2' },
                { id: 'subTokenInput', key: 'ipinfo_token_2' }
            ];

            inputs.forEach(({ id, key }) => {
                const input = document.getElementById(id);
                if (input && input.value.trim()) {
                    sessionStorage.setItem(key, input.value.trim());
                }
            });
        }

        // ä»ä¼šè¯å­˜å‚¨æ¢å¤APIå¯†é’¥
        function restoreTokenFromSession() {
            const inputs = [
                { id: 'proxycheckKeyInput', key: 'proxycheck_key_0' },
                { id: 'tokenInput', key: 'ipinfo_token_0' },
                { id: 'batchProxycheckKeyInput', key: 'proxycheck_key_1' },
                { id: 'batchTokenInput', key: 'ipinfo_token_1' },
                { id: 'subProxycheckKeyInput', key: 'proxycheck_key_2' },
                { id: 'subTokenInput', key: 'ipinfo_token_2' }
            ];

            inputs.forEach(({ id, key }) => {
                const input = document.getElementById(id);
                if (input) {
                    const savedValue = sessionStorage.getItem(key);
                    if (savedValue) {
                        input.value = savedValue;
                    }
                }
            });
        }

        // é¡µé¢åŠ è½½æ—¶æ¢å¤token
        document.addEventListener('DOMContentLoaded', function() {
            restoreTokenFromSession();

            // ç›‘å¬APIå¯†é’¥è¾“å…¥å˜åŒ–ï¼Œè‡ªåŠ¨ä¿å­˜
            const apiInputs = [
                'proxycheckKeyInput', 'tokenInput',
                'batchProxycheckKeyInput', 'batchTokenInput',
                'subProxycheckKeyInput', 'subTokenInput'
            ];

            apiInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('blur', saveTokenToSession);
                }
            });
        });

        // ç¤ºä¾‹æ•°æ®å¡«å……åŠŸèƒ½
        function fillExampleIPs() {
            const exampleIPs = [
                '8.8.8.8',
                '1.1.1.1',
                '114.114.114.114',
                '208.67.222.222'
            ];
            document.getElementById('batchIpInput').value = exampleIPs.join('\n');
        }

        function fillExampleSubscriptions() {
            const exampleSubs = [
                'https://raw.githubusercontent.com/mfuu/v2ray/master/v2ray',
                'https://raw.githubusercontent.com/peasoft/NoMoreWalls/master/list_raw.txt'
            ];
            document.getElementById('subscriptionInput').value = exampleSubs.join('\n');
        }
    </script>
</body>
</html>
