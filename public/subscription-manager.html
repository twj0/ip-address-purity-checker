<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订阅链接管理器 - IP纯净度检查工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }

        .subscription-list {
            margin-top: 20px;
        }

        .subscription-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .subscription-item.duplicate {
            border-color: #ff6b6b;
            background: #fff5f5;
        }

        .subscription-item h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .subscription-url {
            font-family: monospace;
            background: #f1f3f4;
            padding: 8px;
            border-radius: 4px;
            word-break: break-all;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .subscription-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active { background: #51cf66; }
        .status-error { background: #ff6b6b; }
        .status-testing { background: #ffd43b; }
        .status-unknown { background: #adb5bd; }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e1e5e9;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .main-content {
                padding: 20px;
            }

            .subscription-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <script src="main.js"></script>
    <div class="container">
        <div class="header">
            <h1>🔐 订阅链接管理器</h1>
            <p>安全管理您的私人订阅链接，支持加密存储和重复检测</p>
        </div>

        <div class="main-content">
            <!-- 统计信息 -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalSubscriptions">0</div>
                    <div class="stat-label">总订阅数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeSubscriptions">0</div>
                    <div class="stat-label">活跃订阅</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="duplicateSubscriptions">0</div>
                    <div class="stat-label">重复订阅</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="lastChecked">从未</div>
                    <div class="stat-label">最后检查</div>
                </div>
            </div>

            <!-- 提示信息 -->
            <div id="alertContainer"></div>

            <!-- 添加新订阅 -->
            <div class="section">
                <h2>📝 添加新订阅</h2>
                <form id="addSubscriptionForm">
                    <div class="form-group">
                        <label for="subscriptionName">订阅名称:</label>
                        <input type="text" id="subscriptionName" placeholder="例如: 机场A - 高速节点" required>
                    </div>
                    <div class="form-group">
                        <label for="subscriptionUrl">订阅链接:</label>
                        <textarea id="subscriptionUrl" rows="3" placeholder="https://example.com/subscription" required></textarea>
                        <small style="color: #666;">支持vmess、vless、trojan、ss、ssr等协议订阅</small>
                    </div>
                    <div class="form-group">
                        <label for="subscriptionTags">标签 (可选):</label>
                        <input type="text" id="subscriptionTags" placeholder="高速,稳定,美国">
                        <small style="color: #666;">用逗号分隔多个标签</small>
                    </div>
                    <button type="submit" class="btn">➕ 添加订阅</button>
                    <button type="button" class="btn btn-success" onclick="checkAllSubscriptions()">🔍 检查所有订阅</button>
                </form>
            </div>

            <!-- 订阅列表 -->
            <div class="section">
                <h2>📋 我的订阅列表</h2>
                <div class="subscription-actions" style="margin-bottom: 20px;">
                    <button class="btn" onclick="loadSubscriptions()">🔄 刷新列表</button>
                    <button class="btn" onclick="checkSingleIP()">🔍 检查单个IP</button>
                    <button class="btn btn-success" onclick="deduplicateSubscriptions()">🧹 去重处理</button>
                    <button class="btn btn-danger" onclick="clearAllSubscriptions()">🗑️ 清空所有</button>
                </div>
                <div id="ipCheckResult" class="result" style="display: none;"></div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>正在加载订阅列表...</p>
                </div>

                <div id="subscriptionList" class="subscription-list">
                    <!-- 订阅项目将在这里动态加载 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let subscriptions = [];
        let duplicates = new Set();

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadSubscriptions();
            
            // 绑定表单提交事件
            document.getElementById('addSubscriptionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addSubscription();
            });
        });

        // 显示提示信息
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);
            
            // 3秒后自动隐藏
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }

        // 生成唯一ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // 简单的加密函数（实际应用中应使用更强的加密）
        function simpleEncrypt(text) {
            return btoa(encodeURIComponent(text));
        }

        // 简单的解密函数
        function simpleDecrypt(encrypted) {
            try {
                return decodeURIComponent(atob(encrypted));
            } catch (e) {
                return encrypted; // 如果解密失败，返回原文
            }
        }

        // 添加订阅
        async function addSubscription() {
            const name = document.getElementById('subscriptionName').value.trim();
            const url = document.getElementById('subscriptionUrl').value.trim();
            const tags = document.getElementById('subscriptionTags').value.trim();

            if (!name || !url) {
                showAlert('请填写订阅名称和链接', 'error');
                return;
            }

            // 检查URL格式
            if (!isValidUrl(url)) {
                showAlert('请输入有效的订阅链接', 'error');
                return;
            }

            // 检查是否重复
            const isDuplicate = subscriptions.some(sub => sub.url === url);
            if (isDuplicate) {
                showAlert('该订阅链接已存在', 'warning');
                return;
            }

            const subscription = {
                id: generateId(),
                name: name,
                url: url,
                tags: tags.split(',').map(tag => tag.trim()).filter(tag => tag),
                createdAt: new Date().toISOString(),
                lastChecked: null,
                status: 'unknown',
                nodeCount: 0,
                pureNodeCount: 0
            };

            try {
                // 保存到KV存储（加密）
                await saveSubscriptionToKV(subscription);
                
                // 添加到本地列表
                subscriptions.push(subscription);
                
                // 清空表单
                document.getElementById('addSubscriptionForm').reset();
                
                // 刷新显示
                renderSubscriptions();
                updateStats();
                
                showAlert('订阅添加成功', 'success');
            } catch (error) {
                console.error('添加订阅失败:', error);
                showAlert('添加订阅失败: ' + error.message, 'error');
            }
        }

        // 验证URL格式
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // 保存订阅到KV存储
        async function saveSubscriptionToKV(subscription) {
            const encryptedData = {
                ...subscription,
                url: simpleEncrypt(subscription.url) // 加密URL
            };

            const response = await fetch('/api/subscription-manager', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'save',
                    subscription: encryptedData
                })
            });

            if (!response.ok) {
                throw new Error('保存失败');
            }
        }

        // 从KV存储加载订阅
        async function loadSubscriptions() {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            try {
                const response = await fetch('/api/subscription-manager?action=list');
                if (response.ok) {
                    const data = await response.json();
                    subscriptions = data.subscriptions.map(sub => ({
                        ...sub,
                        url: simpleDecrypt(sub.url) // 解密URL
                    }));
                } else {
                    subscriptions = [];
                }

                renderSubscriptions();
                updateStats();
                detectDuplicates();
            } catch (error) {
                console.error('加载订阅失败:', error);
                showAlert('加载订阅列表失败', 'error');
                subscriptions = [];
            } finally {
                loading.style.display = 'none';
            }
        }

        // 渲染订阅列表
        function renderSubscriptions() {
            const container = document.getElementById('subscriptionList');
            
            if (subscriptions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>📭 暂无订阅</h3>
                        <p>添加您的第一个订阅链接开始使用</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = subscriptions.map(sub => `
                <div class="subscription-item ${duplicates.has(sub.url) ? 'duplicate' : ''}" data-id="${sub.id}">
                    <h3>
                        <span class="status-indicator status-${sub.status}"></span>
                        ${sub.name}
                        ${duplicates.has(sub.url) ? '<span style="color: #ff6b6b;">🔄 重复</span>' : ''}
                    </h3>
                    <div class="subscription-url">${sub.url.substring(0, 80)}${sub.url.length > 80 ? '...' : ''}</div>
                    <div style="margin-bottom: 10px;">
                        <small style="color: #666;">
                            📅 创建时间: ${new Date(sub.createdAt).toLocaleString()} | 
                            🔍 最后检查: ${sub.lastChecked ? new Date(sub.lastChecked).toLocaleString() : '从未'} |
                            📊 节点数: ${sub.nodeCount} (纯净: ${sub.pureNodeCount})
                        </small>
                    </div>
                    ${sub.tags.length > 0 ? `
                        <div style="margin-bottom: 10px;">
                            ${sub.tags.map(tag => `<span style="background: #e9ecef; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 5px;">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                    <div class="subscription-actions">
                        <button class="btn" onclick="testSubscription('${sub.id}')">🧪 测试连接</button>
                        <button class="btn" onclick="editSubscription('${sub.id}')">✏️ 编辑</button>
                        <button class="btn btn-danger" onclick="deleteSubscription('${sub.id}')">🗑️ 删除</button>
                    </div>
                </div>
            `).join('');
        }

        // 更新统计信息
        function updateStats() {
            document.getElementById('totalSubscriptions').textContent = subscriptions.length;
            document.getElementById('activeSubscriptions').textContent = subscriptions.filter(sub => sub.status === 'active').length;
            document.getElementById('duplicateSubscriptions').textContent = duplicates.size;
            
            const lastChecked = subscriptions.reduce((latest, sub) => {
                if (sub.lastChecked && (!latest || new Date(sub.lastChecked) > new Date(latest))) {
                    return sub.lastChecked;
                }
                return latest;
            }, null);
            
            document.getElementById('lastChecked').textContent = lastChecked ? 
                new Date(lastChecked).toLocaleString() : '从未';
        }

        // 检测重复订阅
        function detectDuplicates() {
            duplicates.clear();
            const urlCounts = {};
            
            subscriptions.forEach(sub => {
                urlCounts[sub.url] = (urlCounts[sub.url] || 0) + 1;
            });
            
            Object.keys(urlCounts).forEach(url => {
                if (urlCounts[url] > 1) {
                    duplicates.add(url);
                }
            });
        }

        // 测试订阅连接
        async function testSubscription(id) {
            const subscription = subscriptions.find(sub => sub.id === id);
            if (!subscription) return;

            try {
                showAlert('正在测试订阅连接...', 'success');
                
                const response = await fetch('/api/subscription-manager', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'test',
                        url: subscription.url
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    subscription.status = 'active';
                    subscription.nodeCount = result.nodeCount || 0;
                    subscription.lastChecked = new Date().toISOString();
                    showAlert(`测试成功！发现 ${result.nodeCount} 个节点`, 'success');
                } else {
                    subscription.status = 'error';
                    showAlert('测试失败: ' + result.error, 'error');
                }

                await saveSubscriptionToKV(subscription);
                renderSubscriptions();
                updateStats();
            } catch (error) {
                console.error('测试订阅失败:', error);
                showAlert('测试失败: ' + error.message, 'error');
            }
        }

        // 删除订阅
        async function deleteSubscription(id) {
            if (!confirm('确定要删除这个订阅吗？')) return;

            try {
                await fetch('/api/subscription-manager', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'delete',
                        id: id
                    })
                });

                subscriptions = subscriptions.filter(sub => sub.id !== id);
                renderSubscriptions();
                updateStats();
                detectDuplicates();
                showAlert('订阅删除成功', 'success');
            } catch (error) {
                console.error('删除订阅失败:', error);
                showAlert('删除失败: ' + error.message, 'error');
            }
        }

        // 去重处理
        async function deduplicateSubscriptions() {
            if (duplicates.size === 0) {
                showAlert('没有发现重复的订阅', 'warning');
                return;
            }

            if (!confirm(`发现 ${duplicates.size} 个重复订阅，确定要去重吗？将保留最新的订阅。`)) return;

            try {
                const urlToLatest = {};
                
                // 找出每个URL的最新订阅
                subscriptions.forEach(sub => {
                    if (!urlToLatest[sub.url] || new Date(sub.createdAt) > new Date(urlToLatest[sub.url].createdAt)) {
                        urlToLatest[sub.url] = sub;
                    }
                });

                // 保留最新的，删除其他的
                const toKeep = Object.values(urlToLatest);
                const toDelete = subscriptions.filter(sub => !toKeep.includes(sub));

                for (const sub of toDelete) {
                    await fetch('/api/subscription-manager', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'delete',
                            id: sub.id
                        })
                    });
                }

                subscriptions = toKeep;
                renderSubscriptions();
                updateStats();
                detectDuplicates();
                showAlert(`去重完成，删除了 ${toDelete.length} 个重复订阅`, 'success');
            } catch (error) {
                console.error('去重失败:', error);
                showAlert('去重失败: ' + error.message, 'error');
            }
        }

        // 检查所有订阅
        async function checkAllSubscriptions() {
            if (subscriptions.length === 0) {
                showAlert('没有订阅需要检查', 'warning');
                return;
            }

            showAlert('正在检查所有订阅，请稍候...', 'success');

            try {
                const response = await fetch('/api/subscription-manager', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'check-all',
                        subscriptions: subscriptions.map(sub => ({ id: sub.id, url: sub.url }))
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // 更新订阅状态
                    result.results.forEach(res => {
                        const sub = subscriptions.find(s => s.id === res.id);
                        if (sub) {
                            sub.status = res.success ? 'active' : 'error';
                            sub.nodeCount = res.nodeCount || 0;
                            sub.pureNodeCount = res.pureNodeCount || 0;
                            sub.lastChecked = new Date().toISOString();
                        }
                    });

                    renderSubscriptions();
                    updateStats();
                    showAlert(`检查完成！总节点: ${result.totalNodes}, 纯净节点: ${result.pureNodes}`, 'success');
                } else {
                    showAlert('检查失败: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('检查所有订阅失败:', error);
                showAlert('检查失败: ' + error.message, 'error');
            }
        }

        // 清空所有订阅
        async function clearAllSubscriptions() {
            if (!confirm('确定要删除所有订阅吗？此操作不可恢复！')) return;

            try {
                await fetch('/api/subscription-manager', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'clear-all'
                    })
                });

                subscriptions = [];
                renderSubscriptions();
                updateStats();
                detectDuplicates();
                showAlert('所有订阅已清空', 'success');
            } catch (error) {
                console.error('清空失败:', error);
                showAlert('清空失败: ' + error.message, 'error');
            }
        }

        // 编辑订阅（简化版本）
        function editSubscription(id) {
            const subscription = subscriptions.find(sub => sub.id === id);
            if (!subscription) return;

            const newName = prompt('修改订阅名称:', subscription.name);
            if (newName && newName !== subscription.name) {
                subscription.name = newName;
                saveSubscriptionToKV(subscription);
                renderSubscriptions();
                showAlert('订阅名称已更新', 'success');
            }
        }
    </script>
</body>
</html>
