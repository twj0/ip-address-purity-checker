<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢é˜…é“¾æ¥ç®¡ç†å™¨ - IPçº¯å‡€åº¦æ£€æŸ¥å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }

        .subscription-list {
            margin-top: 20px;
        }

        .subscription-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .subscription-item.duplicate {
            border-color: #ff6b6b;
            background: #fff5f5;
        }

        .subscription-item h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .subscription-url {
            font-family: monospace;
            background: #f1f3f4;
            padding: 8px;
            border-radius: 4px;
            word-break: break-all;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .subscription-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active { background: #51cf66; }
        .status-error { background: #ff6b6b; }
        .status-testing { background: #ffd43b; }
        .status-unknown { background: #adb5bd; }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e1e5e9;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .main-content {
                padding: 20px;
            }

            .subscription-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <script src="main.js"></script>
    <div class="container">
        <div class="header">
            <h1>ğŸ” è®¢é˜…é“¾æ¥ç®¡ç†å™¨</h1>
            <p>å®‰å…¨ç®¡ç†æ‚¨çš„ç§äººè®¢é˜…é“¾æ¥ï¼Œæ”¯æŒåŠ å¯†å­˜å‚¨å’Œé‡å¤æ£€æµ‹</p>
        </div>

        <div class="main-content">
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalSubscriptions">0</div>
                    <div class="stat-label">æ€»è®¢é˜…æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeSubscriptions">0</div>
                    <div class="stat-label">æ´»è·ƒè®¢é˜…</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="duplicateSubscriptions">0</div>
                    <div class="stat-label">é‡å¤è®¢é˜…</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="lastChecked">ä»æœª</div>
                    <div class="stat-label">æœ€åæ£€æŸ¥</div>
                </div>
            </div>

            <!-- æç¤ºä¿¡æ¯ -->
            <div id="alertContainer"></div>

            <!-- æ·»åŠ æ–°è®¢é˜… -->
            <div class="section">
                <h2>ğŸ“ æ·»åŠ æ–°è®¢é˜…</h2>
                <form id="addSubscriptionForm">
                    <div class="form-group">
                        <label for="subscriptionName">è®¢é˜…åç§°:</label>
                        <input type="text" id="subscriptionName" placeholder="ä¾‹å¦‚: æœºåœºA - é«˜é€ŸèŠ‚ç‚¹" required>
                    </div>
                    <div class="form-group">
                        <label for="subscriptionUrl">è®¢é˜…é“¾æ¥:</label>
                        <textarea id="subscriptionUrl" rows="3" placeholder="https://example.com/subscription" required></textarea>
                        <small style="color: #666;">æ”¯æŒvmessã€vlessã€trojanã€ssã€ssrç­‰åè®®è®¢é˜…</small>
                    </div>
                    <div class="form-group">
                        <label for="subscriptionTags">æ ‡ç­¾ (å¯é€‰):</label>
                        <input type="text" id="subscriptionTags" placeholder="é«˜é€Ÿ,ç¨³å®š,ç¾å›½">
                        <small style="color: #666;">ç”¨é€—å·åˆ†éš”å¤šä¸ªæ ‡ç­¾</small>
                    </div>
                    <button type="submit" class="btn">â• æ·»åŠ è®¢é˜…</button>
                    <button type="button" class="btn btn-success" onclick="checkAllSubscriptions()">ğŸ” æ£€æŸ¥æ‰€æœ‰è®¢é˜…</button>
                </form>
            </div>

            <!-- è®¢é˜…åˆ—è¡¨ -->
            <div class="section">
                <h2>ğŸ“‹ æˆ‘çš„è®¢é˜…åˆ—è¡¨</h2>
                <div class="subscription-actions" style="margin-bottom: 20px;">
                    <button class="btn" onclick="loadSubscriptions()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                    <button class="btn" onclick="checkSingleIP()">ğŸ” æ£€æŸ¥å•ä¸ªIP</button>
                    <button class="btn btn-success" onclick="deduplicateSubscriptions()">ğŸ§¹ å»é‡å¤„ç†</button>
                    <button class="btn btn-danger" onclick="clearAllSubscriptions()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
                </div>
                <div id="ipCheckResult" class="result" style="display: none;"></div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åŠ è½½è®¢é˜…åˆ—è¡¨...</p>
                </div>

                <div id="subscriptionList" class="subscription-list">
                    <!-- è®¢é˜…é¡¹ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let subscriptions = [];
        let duplicates = new Set();

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSubscriptions();
            
            // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
            document.getElementById('addSubscriptionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addSubscription();
            });
        });

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }

        // ç”Ÿæˆå”¯ä¸€ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // ç®€å•çš„åŠ å¯†å‡½æ•°ï¼ˆå®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨æ›´å¼ºçš„åŠ å¯†ï¼‰
        function simpleEncrypt(text) {
            return btoa(encodeURIComponent(text));
        }

        // ç®€å•çš„è§£å¯†å‡½æ•°
        function simpleDecrypt(encrypted) {
            try {
                return decodeURIComponent(atob(encrypted));
            } catch (e) {
                return encrypted; // å¦‚æœè§£å¯†å¤±è´¥ï¼Œè¿”å›åŸæ–‡
            }
        }

        // æ·»åŠ è®¢é˜…
        async function addSubscription() {
            const name = document.getElementById('subscriptionName').value.trim();
            const url = document.getElementById('subscriptionUrl').value.trim();
            const tags = document.getElementById('subscriptionTags').value.trim();

            if (!name || !url) {
                showAlert('è¯·å¡«å†™è®¢é˜…åç§°å’Œé“¾æ¥', 'error');
                return;
            }

            // æ£€æŸ¥URLæ ¼å¼
            if (!isValidUrl(url)) {
                showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„è®¢é˜…é“¾æ¥', 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦é‡å¤
            const isDuplicate = subscriptions.some(sub => sub.url === url);
            if (isDuplicate) {
                showAlert('è¯¥è®¢é˜…é“¾æ¥å·²å­˜åœ¨', 'warning');
                return;
            }

            const subscription = {
                id: generateId(),
                name: name,
                url: url,
                tags: tags.split(',').map(tag => tag.trim()).filter(tag => tag),
                createdAt: new Date().toISOString(),
                lastChecked: null,
                status: 'unknown',
                nodeCount: 0,
                pureNodeCount: 0
            };

            try {
                // ä¿å­˜åˆ°KVå­˜å‚¨ï¼ˆåŠ å¯†ï¼‰
                await saveSubscriptionToKV(subscription);
                
                // æ·»åŠ åˆ°æœ¬åœ°åˆ—è¡¨
                subscriptions.push(subscription);
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('addSubscriptionForm').reset();
                
                // åˆ·æ–°æ˜¾ç¤º
                renderSubscriptions();
                updateStats();
                
                showAlert('è®¢é˜…æ·»åŠ æˆåŠŸ', 'success');
            } catch (error) {
                console.error('æ·»åŠ è®¢é˜…å¤±è´¥:', error);
                showAlert('æ·»åŠ è®¢é˜…å¤±è´¥: ' + error.message, 'error');
            }
        }

        // éªŒè¯URLæ ¼å¼
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // ä¿å­˜è®¢é˜…åˆ°KVå­˜å‚¨
        async function saveSubscriptionToKV(subscription) {
            const encryptedData = {
                ...subscription,
                url: simpleEncrypt(subscription.url) // åŠ å¯†URL
            };

            const response = await fetch('/api/subscription-manager', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'save',
                    subscription: encryptedData
                })
            });

            if (!response.ok) {
                throw new Error('ä¿å­˜å¤±è´¥');
            }
        }

        // ä»KVå­˜å‚¨åŠ è½½è®¢é˜…
        async function loadSubscriptions() {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            try {
                const response = await fetch('/api/subscription-manager?action=list');
                if (response.ok) {
                    const data = await response.json();
                    subscriptions = data.subscriptions.map(sub => ({
                        ...sub,
                        url: simpleDecrypt(sub.url) // è§£å¯†URL
                    }));
                } else {
                    subscriptions = [];
                }

                renderSubscriptions();
                updateStats();
                detectDuplicates();
            } catch (error) {
                console.error('åŠ è½½è®¢é˜…å¤±è´¥:', error);
                showAlert('åŠ è½½è®¢é˜…åˆ—è¡¨å¤±è´¥', 'error');
                subscriptions = [];
            } finally {
                loading.style.display = 'none';
            }
        }

        // æ¸²æŸ“è®¢é˜…åˆ—è¡¨
        function renderSubscriptions() {
            const container = document.getElementById('subscriptionList');
            
            if (subscriptions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>ğŸ“­ æš‚æ— è®¢é˜…</h3>
                        <p>æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªè®¢é˜…é“¾æ¥å¼€å§‹ä½¿ç”¨</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = subscriptions.map(sub => `
                <div class="subscription-item ${duplicates.has(sub.url) ? 'duplicate' : ''}" data-id="${sub.id}">
                    <h3>
                        <span class="status-indicator status-${sub.status}"></span>
                        ${sub.name}
                        ${duplicates.has(sub.url) ? '<span style="color: #ff6b6b;">ğŸ”„ é‡å¤</span>' : ''}
                    </h3>
                    <div class="subscription-url">${sub.url.substring(0, 80)}${sub.url.length > 80 ? '...' : ''}</div>
                    <div style="margin-bottom: 10px;">
                        <small style="color: #666;">
                            ğŸ“… åˆ›å»ºæ—¶é—´: ${new Date(sub.createdAt).toLocaleString()} | 
                            ğŸ” æœ€åæ£€æŸ¥: ${sub.lastChecked ? new Date(sub.lastChecked).toLocaleString() : 'ä»æœª'} |
                            ğŸ“Š èŠ‚ç‚¹æ•°: ${sub.nodeCount} (çº¯å‡€: ${sub.pureNodeCount})
                        </small>
                    </div>
                    ${sub.tags.length > 0 ? `
                        <div style="margin-bottom: 10px;">
                            ${sub.tags.map(tag => `<span style="background: #e9ecef; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 5px;">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                    <div class="subscription-actions">
                        <button class="btn" onclick="testSubscription('${sub.id}')">ğŸ§ª æµ‹è¯•è¿æ¥</button>
                        <button class="btn" onclick="editSubscription('${sub.id}')">âœï¸ ç¼–è¾‘</button>
                        <button class="btn btn-danger" onclick="deleteSubscription('${sub.id}')">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('totalSubscriptions').textContent = subscriptions.length;
            document.getElementById('activeSubscriptions').textContent = subscriptions.filter(sub => sub.status === 'active').length;
            document.getElementById('duplicateSubscriptions').textContent = duplicates.size;
            
            const lastChecked = subscriptions.reduce((latest, sub) => {
                if (sub.lastChecked && (!latest || new Date(sub.lastChecked) > new Date(latest))) {
                    return sub.lastChecked;
                }
                return latest;
            }, null);
            
            document.getElementById('lastChecked').textContent = lastChecked ? 
                new Date(lastChecked).toLocaleString() : 'ä»æœª';
        }

        // æ£€æµ‹é‡å¤è®¢é˜…
        function detectDuplicates() {
            duplicates.clear();
            const urlCounts = {};
            
            subscriptions.forEach(sub => {
                urlCounts[sub.url] = (urlCounts[sub.url] || 0) + 1;
            });
            
            Object.keys(urlCounts).forEach(url => {
                if (urlCounts[url] > 1) {
                    duplicates.add(url);
                }
            });
        }

        // æµ‹è¯•è®¢é˜…è¿æ¥
        async function testSubscription(id) {
            const subscription = subscriptions.find(sub => sub.id === id);
            if (!subscription) return;

            try {
                showAlert('æ­£åœ¨æµ‹è¯•è®¢é˜…è¿æ¥...', 'success');
                
                const response = await fetch('/api/subscription-manager', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'test',
                        url: subscription.url
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    subscription.status = 'active';
                    subscription.nodeCount = result.nodeCount || 0;
                    subscription.lastChecked = new Date().toISOString();
                    showAlert(`æµ‹è¯•æˆåŠŸï¼å‘ç° ${result.nodeCount} ä¸ªèŠ‚ç‚¹`, 'success');
                } else {
                    subscription.status = 'error';
                    showAlert('æµ‹è¯•å¤±è´¥: ' + result.error, 'error');
                }

                await saveSubscriptionToKV(subscription);
                renderSubscriptions();
                updateStats();
            } catch (error) {
                console.error('æµ‹è¯•è®¢é˜…å¤±è´¥:', error);
                showAlert('æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤è®¢é˜…
        async function deleteSubscription(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¢é˜…å—ï¼Ÿ')) return;

            try {
                await fetch('/api/subscription-manager', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'delete',
                        id: id
                    })
                });

                subscriptions = subscriptions.filter(sub => sub.id !== id);
                renderSubscriptions();
                updateStats();
                detectDuplicates();
                showAlert('è®¢é˜…åˆ é™¤æˆåŠŸ', 'success');
            } catch (error) {
                console.error('åˆ é™¤è®¢é˜…å¤±è´¥:', error);
                showAlert('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å»é‡å¤„ç†
        async function deduplicateSubscriptions() {
            if (duplicates.size === 0) {
                showAlert('æ²¡æœ‰å‘ç°é‡å¤çš„è®¢é˜…', 'warning');
                return;
            }

            if (!confirm(`å‘ç° ${duplicates.size} ä¸ªé‡å¤è®¢é˜…ï¼Œç¡®å®šè¦å»é‡å—ï¼Ÿå°†ä¿ç•™æœ€æ–°çš„è®¢é˜…ã€‚`)) return;

            try {
                const urlToLatest = {};
                
                // æ‰¾å‡ºæ¯ä¸ªURLçš„æœ€æ–°è®¢é˜…
                subscriptions.forEach(sub => {
                    if (!urlToLatest[sub.url] || new Date(sub.createdAt) > new Date(urlToLatest[sub.url].createdAt)) {
                        urlToLatest[sub.url] = sub;
                    }
                });

                // ä¿ç•™æœ€æ–°çš„ï¼Œåˆ é™¤å…¶ä»–çš„
                const toKeep = Object.values(urlToLatest);
                const toDelete = subscriptions.filter(sub => !toKeep.includes(sub));

                for (const sub of toDelete) {
                    await fetch('/api/subscription-manager', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'delete',
                            id: sub.id
                        })
                    });
                }

                subscriptions = toKeep;
                renderSubscriptions();
                updateStats();
                detectDuplicates();
                showAlert(`å»é‡å®Œæˆï¼Œåˆ é™¤äº† ${toDelete.length} ä¸ªé‡å¤è®¢é˜…`, 'success');
            } catch (error) {
                console.error('å»é‡å¤±è´¥:', error);
                showAlert('å»é‡å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ£€æŸ¥æ‰€æœ‰è®¢é˜…
        async function checkAllSubscriptions() {
            if (subscriptions.length === 0) {
                showAlert('æ²¡æœ‰è®¢é˜…éœ€è¦æ£€æŸ¥', 'warning');
                return;
            }

            showAlert('æ­£åœ¨æ£€æŸ¥æ‰€æœ‰è®¢é˜…ï¼Œè¯·ç¨å€™...', 'success');

            try {
                const response = await fetch('/api/subscription-manager', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'check-all',
                        subscriptions: subscriptions.map(sub => ({ id: sub.id, url: sub.url }))
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // æ›´æ–°è®¢é˜…çŠ¶æ€
                    result.results.forEach(res => {
                        const sub = subscriptions.find(s => s.id === res.id);
                        if (sub) {
                            sub.status = res.success ? 'active' : 'error';
                            sub.nodeCount = res.nodeCount || 0;
                            sub.pureNodeCount = res.pureNodeCount || 0;
                            sub.lastChecked = new Date().toISOString();
                        }
                    });

                    renderSubscriptions();
                    updateStats();
                    showAlert(`æ£€æŸ¥å®Œæˆï¼æ€»èŠ‚ç‚¹: ${result.totalNodes}, çº¯å‡€èŠ‚ç‚¹: ${result.pureNodes}`, 'success');
                } else {
                    showAlert('æ£€æŸ¥å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('æ£€æŸ¥æ‰€æœ‰è®¢é˜…å¤±è´¥:', error);
                showAlert('æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸…ç©ºæ‰€æœ‰è®¢é˜…
        async function clearAllSubscriptions() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰è®¢é˜…å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

            try {
                await fetch('/api/subscription-manager', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'clear-all'
                    })
                });

                subscriptions = [];
                renderSubscriptions();
                updateStats();
                detectDuplicates();
                showAlert('æ‰€æœ‰è®¢é˜…å·²æ¸…ç©º', 'success');
            } catch (error) {
                console.error('æ¸…ç©ºå¤±è´¥:', error);
                showAlert('æ¸…ç©ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç¼–è¾‘è®¢é˜…ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        function editSubscription(id) {
            const subscription = subscriptions.find(sub => sub.id === id);
            if (!subscription) return;

            const newName = prompt('ä¿®æ”¹è®¢é˜…åç§°:', subscription.name);
            if (newName && newName !== subscription.name) {
                subscription.name = newName;
                saveSubscriptionToKV(subscription);
                renderSubscriptions();
                showAlert('è®¢é˜…åç§°å·²æ›´æ–°', 'success');
            }
        }
    </script>
</body>
</html>
