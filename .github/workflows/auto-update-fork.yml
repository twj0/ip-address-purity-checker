name: ðŸ”„ Auto Update Fork

on:
  schedule:
    # æ¯å¤©UTC 02:00æ£€æŸ¥æ›´æ–°ï¼ˆåŒ—äº¬æ—¶é—´10:00ï¼‰
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥å†²çªï¼‰'
        required: false
        default: false
        type: boolean
      notify_user:
        description: 'å‘é€æ›´æ–°é€šçŸ¥'
        required: false
        default: true
        type: boolean
      backup_config:
        description: 'å¤‡ä»½ç”¨æˆ·é…ç½®'
        required: false
        default: true
        type: boolean

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    if: github.repository != 'twj0/ip-address-purity-checker'  # åªåœ¨forkä»“åº“ä¸­è¿è¡Œ
    
    steps:
      - name: Checkout fork repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/twj0/ip-address-purity-checker.git
          git fetch upstream

      - name: Check for updates
        id: check_updates
        run: |
          # èŽ·å–ä¸Šæ¸¸æœ€æ–°æäº¤
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          CURRENT_COMMIT=$(git rev-parse HEAD)
          
          echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
          echo "current_commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
          
          if [ "$UPSTREAM_COMMIT" != "$CURRENT_COMMIT" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "å‘çŽ°ä¸Šæ¸¸æ›´æ–°"
            
            # èŽ·å–æ›´æ–°æ—¥å¿—
            git log --oneline $CURRENT_COMMIT..$UPSTREAM_COMMIT > update_log.txt
            echo "æ›´æ–°å†…å®¹:"
            cat update_log.txt
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰å‘çŽ°æ›´æ–°"
          fi

      - name: Backup user configurations
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          echo "å¤‡ä»½ç”¨æˆ·é…ç½®æ–‡ä»¶..."
          mkdir -p backup
          
          # å¤‡ä»½å¯èƒ½çš„ç”¨æˆ·è‡ªå®šä¹‰æ–‡ä»¶
          [ -f "config.json" ] && cp config.json backup/ || true
          [ -f "wrangler.toml" ] && cp wrangler.toml backup/ || true
          [ -f ".env" ] && cp .env backup/ || true
          [ -f "proxycheck-api-key.txt" ] && cp proxycheck-api-key.txt backup/ || true
          [ -f "ipinfo-token.txt" ] && cp ipinfo-token.txt backup/ || true
          
          # å¤‡ä»½è‡ªå®šä¹‰è®¢é˜…é“¾æŽ¥
          [ -f "æ±‡èšè®¢é˜….txt" ] && cp æ±‡èšè®¢é˜….txt backup/ || true
          
          echo "å¤‡ä»½å®Œæˆ"
          ls -la backup/ || true

      - name: Merge upstream changes
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          echo "åˆå¹¶ä¸Šæ¸¸æ›´æ–°..."
          
          if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
            echo "å¼ºåˆ¶æ›´æ–°æ¨¡å¼"
            git reset --hard upstream/main
          else
            # å°è¯•æ™ºèƒ½åˆå¹¶
            if git merge upstream/main --no-edit; then
              echo "è‡ªåŠ¨åˆå¹¶æˆåŠŸ"
            else
              echo "åˆå¹¶å†²çªï¼Œå°è¯•è§£å†³..."
              
              # å¯¹äºŽç‰¹å®šæ–‡ä»¶ï¼Œä¼˜å…ˆä¿ç•™ç”¨æˆ·ç‰ˆæœ¬
              USER_PRIORITY_FILES=(
                "config.json"
                "wrangler.toml"
                ".env"
                "proxycheck-api-key.txt"
                "ipinfo-token.txt"
                "æ±‡èšè®¢é˜….txt"
              )
              
              for file in "${USER_PRIORITY_FILES[@]}"; do
                if git status --porcelain | grep -q "^UU $file"; then
                  echo "ä¿ç•™ç”¨æˆ·ç‰ˆæœ¬: $file"
                  git checkout --ours "$file"
                  git add "$file"
                fi
              done
              
              # å¯¹äºŽä»£ç æ–‡ä»¶ï¼Œä¼˜å…ˆä½¿ç”¨ä¸Šæ¸¸ç‰ˆæœ¬
              CODE_FILES=$(git status --porcelain | grep "^UU" | grep -E "\.(js|py|html|css|md)$" | awk '{print $2}')
              for file in $CODE_FILES; do
                echo "ä½¿ç”¨ä¸Šæ¸¸ç‰ˆæœ¬: $file"
                git checkout --theirs "$file"
                git add "$file"
              done
              
              # å®Œæˆåˆå¹¶
              git commit --no-edit || true
            fi
          fi

      - name: Restore user configurations
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          echo "æ¢å¤ç”¨æˆ·é…ç½®..."
          
          # æ¢å¤ç”¨æˆ·é…ç½®æ–‡ä»¶ï¼ˆå¦‚æžœå¤‡ä»½å­˜åœ¨ä¸”å½“å‰æ–‡ä»¶è¢«è¦†ç›–ï¼‰
          if [ -f "backup/config.json" ] && [ -f "config.json" ]; then
            # æ£€æŸ¥æ˜¯å¦éœ€è¦åˆå¹¶é…ç½®
            if ! cmp -s backup/config.json config.json; then
              echo "æ£€æµ‹åˆ°config.jsonå˜åŒ–ï¼Œä¿ç•™ç”¨æˆ·é…ç½®"
              cp backup/config.json config.json
            fi
          fi
          
          # æ¢å¤wrangler.tomlä¸­çš„KVå‘½åç©ºé—´ID
          if [ -f "backup/wrangler.toml" ]; then
            # æå–ç”¨æˆ·çš„KVå‘½åç©ºé—´ID
            USER_KV_ID=$(grep 'id = "' backup/wrangler.toml | head -1 | sed 's/.*id = "\([^"]*\)".*/\1/')
            USER_PREVIEW_ID=$(grep 'preview_id = "' backup/wrangler.toml | head -1 | sed 's/.*preview_id = "\([^"]*\)".*/\1/')
            
            if [ -n "$USER_KV_ID" ] && [ "$USER_KV_ID" != "" ]; then
              echo "æ¢å¤KVå‘½åç©ºé—´ID: $USER_KV_ID"
              sed -i "s/id = \"\"/id = \"$USER_KV_ID\"/" wrangler.toml
            fi
            
            if [ -n "$USER_PREVIEW_ID" ] && [ "$USER_PREVIEW_ID" != "" ]; then
              echo "æ¢å¤é¢„è§ˆKVå‘½åç©ºé—´ID: $USER_PREVIEW_ID"
              sed -i "s/preview_id = \"\"/preview_id = \"$USER_PREVIEW_ID\"/" wrangler.toml
            fi
          fi
          
          # æ¢å¤APIå¯†é’¥æ–‡ä»¶
          [ -f "backup/proxycheck-api-key.txt" ] && cp backup/proxycheck-api-key.txt . || true
          [ -f "backup/ipinfo-token.txt" ] && cp backup/ipinfo-token.txt . || true
          [ -f "backup/.env" ] && cp backup/.env . || true
          
          # æ¢å¤è‡ªå®šä¹‰è®¢é˜…
          [ -f "backup/æ±‡èšè®¢é˜….txt" ] && cp backup/æ±‡èšè®¢é˜….txt . || true
          
          echo "é…ç½®æ¢å¤å®Œæˆ"

      - name: Commit and push changes
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–éœ€è¦æäº¤
          if git diff --staged --quiet && git diff --quiet; then
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„å˜åŒ–"
          else
            echo "æäº¤æ›´æ–°..."
            git add -A
            
            # åˆ›å»ºæ›´æ–°æäº¤ä¿¡æ¯
            COMMIT_MSG="ðŸ”„ Auto-update from upstream

            Merged changes from twj0/ip-address-purity-checker
            Upstream commit: ${{ steps.check_updates.outputs.upstream_commit }}

            Changes:
            $(cat update_log.txt || echo 'See git log for details')

            User configurations preserved:
            - KV namespace IDs
            - API keys and tokens
            - Custom subscription URLs
            - Personal settings"
            
            git commit -m "$COMMIT_MSG" || true
            git push origin main
            
            echo "æ›´æ–°æŽ¨é€å®Œæˆ"
          fi

      - name: Create detailed update summary
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          echo "## ðŸ”„ è‡ªåŠ¨æ›´æ–°å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š æ›´æ–°ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ä¸Šæ¸¸ä»“åº“ | [twj0/ip-address-purity-checker](https://github.com/twj0/ip-address-purity-checker) |" >> $GITHUB_STEP_SUMMARY
          echo "| æ›´æ–°æ—¶é—´ | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| ä¸Šæ¸¸æäº¤ | [\`${UPSTREAM_COMMIT:0:8}\`](https://github.com/twj0/ip-address-purity-checker/commit/${{ steps.check_updates.outputs.upstream_commit }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| å½“å‰æäº¤ | [\`${CURRENT_COMMIT:0:8}\`](https://github.com/${{ github.repository }}/commit/${{ steps.check_updates.outputs.current_commit }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| æ›´æ–°æ–¹å¼ | ${{ github.event.inputs.force_update == 'true' && 'å¼ºåˆ¶æ›´æ–°' || 'æ™ºèƒ½åˆå¹¶' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“ æ›´æ–°å†…å®¹" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†æ›´æ–°æ—¥å¿—</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          if [ -f "update_log.txt" ]; then
            cat update_log.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "æ— æ³•è¯»å–æ›´æ–°æ—¥å¿—ï¼Œè¯·æŸ¥çœ‹Gitæäº¤åŽ†å²" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### âœ… ä¿æŠ¤çš„ç”¨æˆ·é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "ä»¥ä¸‹é…ç½®åœ¨æ›´æ–°è¿‡ç¨‹ä¸­è¢«è‡ªåŠ¨ä¿æŠ¤ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”‘ **KVå‘½åç©ºé—´é…ç½®**: wrangler.tomlä¸­çš„å‘½åç©ºé—´ID" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” **APIå¯†é’¥è®¾ç½®**: ProxyCheck.ioå’ŒIPinfo.ioå¯†é’¥" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¡ **è®¢é˜…é“¾æŽ¥**: å­˜å‚¨åœ¨KVä¸­çš„ç§äººè®¢é˜…é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "- âš™ï¸ **çŽ¯å¢ƒå˜é‡**: è‡ªå®šä¹‰çš„çŽ¯å¢ƒå˜é‡é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ **é…ç½®æ–‡ä»¶**: config.jsonå’Œå…¶ä»–ä¸ªäººé…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸš€ å»ºè®®çš„åŽç»­æ“ä½œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### 1. éªŒè¯æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "- è®¿é—®æ‚¨çš„Webç•Œé¢ç¡®è®¤åŠŸèƒ½æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
          echo "- æ£€æŸ¥è®¢é˜…ç®¡ç†å™¨æ˜¯å¦å·¥ä½œæ­£å¸¸" >> $GITHUB_STEP_SUMMARY
          echo "- æµ‹è¯•APIå¯†é’¥é…ç½®æ˜¯å¦ä¿ç•™" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### 2. é‡æ–°éƒ¨ç½²ï¼ˆå¦‚éœ€è¦ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo '# æ›´æ–°Workerï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰' >> $GITHUB_STEP_SUMMARY
          echo 'wrangler deploy' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '# æ›´æ–°Pagesï¼ˆWebç•Œé¢ï¼‰' >> $GITHUB_STEP_SUMMARY
          echo 'wrangler pages deploy public --project-name ip-purity-checker' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### 3. æ£€æŸ¥æ–°åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
          echo "- æŸ¥çœ‹[æ›´æ–°æ—¥å¿—](https://github.com/twj0/ip-address-purity-checker/releases)äº†è§£æ–°åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
          echo "- é˜…è¯»[æ–‡æ¡£](https://github.com/twj0/ip-address-purity-checker#readme)äº†è§£ä½¿ç”¨æ–¹æ³•" >> $GITHUB_STEP_SUMMARY
          echo "- å¦‚æœ‰é—®é¢˜è¯·[æäº¤Issue](https://github.com/twj0/ip-address-purity-checker/issues)" >> $GITHUB_STEP_SUMMARY

      - name: No updates found
        if: steps.check_updates.outputs.has_updates == 'false'
        run: |
          echo "## âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ‚¨çš„forkä»“åº“å·²ç»æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ£€æŸ¥æ—¶é—´:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**å½“å‰æäº¤:** ${{ steps.check_updates.outputs.current_commit }}" >> $GITHUB_STEP_SUMMARY

  # å¯é€‰ï¼šè‡ªåŠ¨é‡æ–°éƒ¨ç½²åˆ°Cloudflareï¼ˆå¦‚æžœé…ç½®äº†secretsï¼‰
  auto-redeploy:
    needs: check-and-update
    runs-on: ubuntu-latest
    if: ${{ needs.check-and-update.outputs.has_updates == 'true' && secrets.CLOUDFLARE_API_TOKEN != '' }}

    steps:
      - name: Checkout updated repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # ç§»é™¤cacheé€‰é¡¹ï¼Œå› ä¸ºæ²¡æœ‰package-lock.jsonæ–‡ä»¶

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy Worker to Cloudflare
        id: deploy-worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "éƒ¨ç½²Workeråˆ°Cloudflare..."

          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "âš ï¸ CLOUDFLARE_API_TOKENæœªé…ç½®ï¼Œè·³è¿‡Workeréƒ¨ç½²"
            echo "worker_deploy_success=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          if wrangler deploy; then
            echo "âœ… Workeréƒ¨ç½²æˆåŠŸ"
            echo "worker_deploy_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Workeréƒ¨ç½²å¤±è´¥"
            echo "worker_deploy_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Deploy Pages to Cloudflare (if exists)
        id: deploy-pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "æ£€æŸ¥æ˜¯å¦éœ€è¦éƒ¨ç½²Pages..."

          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "âš ï¸ CLOUDFLARE_API_TOKENæœªé…ç½®ï¼Œè·³è¿‡Pageséƒ¨ç½²"
            echo "pages_deploy_success=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨publicç›®å½•æˆ–Pagesé…ç½®
          if [ -d "public" ] || [ -f "functions/_middleware.js" ]; then
            echo "å‘çŽ°Pagesèµ„æºï¼Œå¼€å§‹éƒ¨ç½²..."

            # ä¿®å¤ï¼šç§»é™¤ä¸æ”¯æŒçš„å‚æ•°
            if wrangler pages deploy public --project-name ip-purity-checker; then
              echo "âœ… Pageséƒ¨ç½²æˆåŠŸ"
              echo "pages_deploy_success=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ Pageséƒ¨ç½²å¤±è´¥ï¼Œä½†ä¸å½±å“WorkeråŠŸèƒ½"
              echo "pages_deploy_success=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "â„¹ï¸ æœªå‘çŽ°Pagesèµ„æºï¼Œè·³è¿‡Pageséƒ¨ç½²"
            echo "pages_deploy_success=skipped" >> $GITHUB_OUTPUT
          fi

      - name: Update deployment summary
        if: always()
        run: |
          echo "## ðŸš€ è‡ªåŠ¨éƒ¨ç½²ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æœåŠ¡ | çŠ¶æ€ | è¯´æ˜Ž |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY

          # Workeréƒ¨ç½²çŠ¶æ€
          if [ "${{ steps.deploy-worker.outputs.worker_deploy_success }}" = "true" ]; then
            echo "| Cloudflare Worker | âœ… æˆåŠŸ | å®šæ—¶ä»»åŠ¡å’ŒAPIå·²æ›´æ–° |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Cloudflare Worker | âŒ å¤±è´¥ | è¯·æ£€æŸ¥API Tokené…ç½® |" >> $GITHUB_STEP_SUMMARY
          fi

          # Pageséƒ¨ç½²çŠ¶æ€
          case "${{ steps.deploy-pages.outputs.pages_deploy_success }}" in
            "true")
              echo "| Cloudflare Pages | âœ… æˆåŠŸ | Webç•Œé¢å·²æ›´æ–° |" >> $GITHUB_STEP_SUMMARY
              ;;
            "false")
              echo "| Cloudflare Pages | âŒ å¤±è´¥ | Webç•Œé¢å¯èƒ½éœ€è¦æ‰‹åŠ¨éƒ¨ç½² |" >> $GITHUB_STEP_SUMMARY
              ;;
            "skipped")
              echo "| Cloudflare Pages | â­ï¸ è·³è¿‡ | æœªå‘çŽ°Pagesèµ„æº |" >> $GITHUB_STEP_SUMMARY
              ;;
          esac

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ éƒ¨ç½²è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Worker**: å¤„ç†å®šæ—¶ä»»åŠ¡ã€APIæŽ¥å£å’Œæ ¸å¿ƒé€»è¾‘" >> $GITHUB_STEP_SUMMARY
          echo "- **Pages**: æä¾›Webç®¡ç†ç•Œé¢ï¼ˆå¦‚æžœé…ç½®ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å¦‚æžœéƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "1. `CLOUDFLARE_API_TOKEN` æ˜¯å¦æ­£ç¡®é…ç½®åœ¨ä»“åº“Secretsä¸­" >> $GITHUB_STEP_SUMMARY
          echo "2. API Tokenæ˜¯å¦æœ‰è¶³å¤Ÿçš„æƒé™ï¼ˆWorkers:Edit, Zone:Readï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "3. `wrangler.toml` é…ç½®æ˜¯å¦æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
