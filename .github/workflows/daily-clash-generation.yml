name: ğŸ“… Daily Clash Config Generation

on:
  schedule:
    # æ¯æ—¥UTC 18:00ç”ŸæˆClashé…ç½®ï¼ˆåŒ—äº¬æ—¶é—´02:00ï¼‰
    - cron: '0 18 * * *'
  workflow_dispatch:
    inputs:
      force_generation:
        description: 'å¼ºåˆ¶é‡æ–°ç”Ÿæˆé…ç½®'
        required: false
        default: false
        type: boolean
      include_all_nodes:
        description: 'åŒ…å«æ‰€æœ‰èŠ‚ç‚¹ï¼ˆä¸ä»…çº¯å‡€èŠ‚ç‚¹ï¼‰'
        required: false
        default: false
        type: boolean

jobs:
  generate-clash-config:
    runs-on: ubuntu-latest
    if: github.repository != 'twj0/ip-address-purity-checker'  # åªåœ¨forkä»“åº“ä¸­è¿è¡Œ
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install -g wrangler
          npm install js-yaml

      - name: Generate Clash configuration
        id: generate_config
        run: |
          echo "å¼€å§‹ç”ŸæˆClashé…ç½®..."
          
          # è·å–å½“å‰æ—¶é—´
          CURRENT_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          echo "generation_time=$CURRENT_TIME" >> $GITHUB_OUTPUT
          
          # åˆ›å»ºåŸºç¡€Clashé…ç½®
          cat > public/clash-config.yaml << 'EOF'
          # Clashé…ç½®æ–‡ä»¶ - çº¯å‡€IPèŠ‚ç‚¹
          # ç”Ÿæˆæ—¶é—´: $CURRENT_TIME
          # æ•°æ®æ¥æº: IP Purity Checker
          # æ›´æ–°é¢‘ç‡: æ¯æ—¥è‡ªåŠ¨æ›´æ–°
          
          port: 7890
          socks-port: 7891
          allow-lan: false
          mode: Rule
          log-level: info
          external-controller: 127.0.0.1:9090
          
          # DNSé…ç½®
          dns:
            enable: true
            listen: 0.0.0.0:53
            default-nameserver:
              - 223.5.5.5
              - 119.29.29.29
            nameserver:
              - https://doh.pub/dns-query
              - https://dns.alidns.com/dns-query
            fallback-filter:
              geoip: true
              geoip-code: CN
          
          # ä»£ç†é…ç½®ï¼ˆå°†é€šè¿‡APIåŠ¨æ€ç”Ÿæˆï¼‰
          proxies: []
          
          # ä»£ç†ç»„é…ç½®
          proxy-groups:
            - name: ğŸš€ èŠ‚ç‚¹é€‰æ‹©
              type: select
              proxies:
                - â™»ï¸ è‡ªåŠ¨é€‰æ‹©
                - ğŸ”¯ æ•…éšœè½¬ç§»
                - ğŸ¯ å…¨çƒç›´è¿
                - DIRECT
            
            - name: â™»ï¸ è‡ªåŠ¨é€‰æ‹©
              type: url-test
              proxies: []
              url: http://www.gstatic.com/generate_204
              interval: 300
              tolerance: 50
            
            - name: ğŸ”¯ æ•…éšœè½¬ç§»
              type: fallback
              proxies: []
              url: http://www.gstatic.com/generate_204
              interval: 300
            
            - name: ğŸŒ å›½å¤–åª’ä½“
              type: select
              proxies:
                - ğŸš€ èŠ‚ç‚¹é€‰æ‹©
                - â™»ï¸ è‡ªåŠ¨é€‰æ‹©
                - ğŸ¯ å…¨çƒç›´è¿
            
            - name: ğŸ“º å“”å“©å“”å“©
              type: select
              proxies:
                - ğŸ¯ å…¨çƒç›´è¿
                - ğŸš€ èŠ‚ç‚¹é€‰æ‹©
            
            - name: ğŸ¯ å…¨çƒç›´è¿
              type: select
              proxies:
                - DIRECT
                - ğŸš€ èŠ‚ç‚¹é€‰æ‹©
            
            - name: ğŸ›‘ å¹¿å‘Šæ‹¦æˆª
              type: select
              proxies:
                - REJECT
                - DIRECT
            
            - name: ğŸŸ æ¼ç½‘ä¹‹é±¼
              type: select
              proxies:
                - ğŸš€ èŠ‚ç‚¹é€‰æ‹©
                - ğŸ¯ å…¨çƒç›´è¿
          
          # è§„åˆ™é…ç½®
          rules:
            # å¹¿å‘Šæ‹¦æˆª
            - DOMAIN-SUFFIX,googlesyndication.com,ğŸ›‘ å¹¿å‘Šæ‹¦æˆª
            - DOMAIN-SUFFIX,googleadservices.com,ğŸ›‘ å¹¿å‘Šæ‹¦æˆª
            - DOMAIN-SUFFIX,doubleclick.net,ğŸ›‘ å¹¿å‘Šæ‹¦æˆª
            
            # å“”å“©å“”å“©
            - DOMAIN-SUFFIX,bilibili.com,ğŸ“º å“”å“©å“”å“©
            - DOMAIN-SUFFIX,hdslb.com,ğŸ“º å“”å“©å“”å“©
            - DOMAIN-SUFFIX,biliapi.net,ğŸ“º å“”å“©å“”å“©
            
            # å›½å¤–åª’ä½“
            - DOMAIN-SUFFIX,youtube.com,ğŸŒ å›½å¤–åª’ä½“
            - DOMAIN-SUFFIX,netflix.com,ğŸŒ å›½å¤–åª’ä½“
            - DOMAIN-SUFFIX,twitter.com,ğŸŒ å›½å¤–åª’ä½“
            - DOMAIN-SUFFIX,facebook.com,ğŸŒ å›½å¤–åª’ä½“
            - DOMAIN-SUFFIX,instagram.com,ğŸŒ å›½å¤–åª’ä½“
            - DOMAIN-SUFFIX,telegram.org,ğŸŒ å›½å¤–åª’ä½“
            
            # æœ¬åœ°ç½‘ç»œ
            - DOMAIN-SUFFIX,local,ğŸ¯ å…¨çƒç›´è¿
            - IP-CIDR,127.0.0.0/8,ğŸ¯ å…¨çƒç›´è¿
            - IP-CIDR,172.16.0.0/12,ğŸ¯ å…¨çƒç›´è¿
            - IP-CIDR,192.168.0.0/16,ğŸ¯ å…¨çƒç›´è¿
            - IP-CIDR,10.0.0.0/8,ğŸ¯ å…¨çƒç›´è¿
            
            # ä¸­å›½å¤§é™†
            - GEOIP,CN,ğŸ¯ å…¨çƒç›´è¿
            
            # å…¶ä»–
            - MATCH,ğŸŸ æ¼ç½‘ä¹‹é±¼
          EOF
          
          # æ›¿æ¢æ—¶é—´æˆ³
          sed -i "s/\$CURRENT_TIME/$CURRENT_TIME/g" public/clash-config.yaml
          
          echo "âœ… åŸºç¡€Clashé…ç½®ç”Ÿæˆå®Œæˆ"
          echo "config_size=$(wc -c < public/clash-config.yaml)" >> $GITHUB_OUTPUT

      - name: Create configuration metadata
        run: |
          # åˆ›å»ºé…ç½®å…ƒæ•°æ®
          cat > public/clash-config.json << EOF
          {
            "name": "IP Purity Checker - Clash Config",
            "description": "åŸºäºIPçº¯å‡€åº¦æ£€æµ‹çš„Clashé…ç½®æ–‡ä»¶",
            "version": "$(date +%Y%m%d)",
            "generated_at": "$(date -u '+%Y-%m-%d %H:%M:%S UTC')",
            "update_interval": "daily",
            "total_nodes": 0,
            "pure_nodes": 0,
            "countries": [],
            "download_urls": {
              "yaml": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/clash-config.yaml",
              "json": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/clash-config.json"
            },
            "usage_instructions": {
              "clash": "å°†YAMLæ–‡ä»¶URLæ·»åŠ åˆ°Clashå®¢æˆ·ç«¯çš„é…ç½®è®¢é˜…ä¸­",
              "clash_for_windows": "åœ¨Profilesé¡µé¢ç‚¹å‡»Download from a URL",
              "clash_for_android": "åœ¨é…ç½®é¡µé¢æ·»åŠ URLè®¢é˜…",
              "clash_verge": "åœ¨è®¢é˜…é¡µé¢æ·»åŠ é…ç½®é“¾æ¥"
            },
            "update_schedule": "æ¯æ—¥UTC 18:00è‡ªåŠ¨æ›´æ–°",
            "source_repository": "https://github.com/twj0/ip-address-purity-checker",
            "fork_repository": "https://github.com/${{ github.repository }}"
          }
          EOF

      - name: Optimize configuration file
        run: |
          echo "ä¼˜åŒ–é…ç½®æ–‡ä»¶..."
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          CONFIG_SIZE=$(wc -c < public/clash-config.yaml)
          echo "é…ç½®æ–‡ä»¶å¤§å°: $CONFIG_SIZE bytes"
          
          # å¦‚æœæ–‡ä»¶è¿‡å¤§ï¼Œè¿›è¡Œä¼˜åŒ–
          if [ $CONFIG_SIZE -gt 1048576 ]; then  # 1MB
            echo "âš ï¸ é…ç½®æ–‡ä»¶è¿‡å¤§ï¼Œè¿›è¡Œä¼˜åŒ–..."
            
            # ç§»é™¤æ³¨é‡Šå’Œç©ºè¡Œä»¥å‡å°æ–‡ä»¶å¤§å°
            sed -i '/^[[:space:]]*#/d; /^[[:space:]]*$/d' public/clash-config.yaml
            
            NEW_SIZE=$(wc -c < public/clash-config.yaml)
            echo "ä¼˜åŒ–åå¤§å°: $NEW_SIZE bytes"
          fi
          
          # éªŒè¯YAMLæ ¼å¼
          if command -v node >/dev/null 2>&1; then
            node -e "
              const yaml = require('js-yaml');
              const fs = require('fs');
              try {
                const config = yaml.load(fs.readFileSync('public/clash-config.yaml', 'utf8'));
                console.log('âœ… YAMLæ ¼å¼éªŒè¯é€šè¿‡');
                console.log('ä»£ç†ç»„æ•°é‡:', config['proxy-groups']?.length || 0);
                console.log('è§„åˆ™æ•°é‡:', config.rules?.length || 0);
              } catch (e) {
                console.error('âŒ YAMLæ ¼å¼é”™è¯¯:', e.message);
                process.exit(1);
              }
            "
          fi

      - name: Commit and push changes
        run: |
          # é…ç½®Git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet public/clash-config.yaml public/clash-config.json; then
            echo "ğŸ“ é…ç½®æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            echo "ğŸ“ æäº¤é…ç½®æ–‡ä»¶æ›´æ–°..."
            
            git add public/clash-config.yaml public/clash-config.json
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°Clashé…ç½®æ–‡ä»¶

            - ç”Ÿæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            - é…ç½®å¤§å°: $(wc -c < public/clash-config.yaml) bytes
            - è§¦å‘æ–¹å¼: ${{ github.event_name }}
            - å·¥ä½œæµ: ${{ github.workflow }}
            
            [skip ci]"
            
            git push
            echo "âœ… é…ç½®æ–‡ä»¶å·²æ¨é€åˆ°ä»“åº“"
          fi

      - name: Deploy to GitHub Pages (if enabled)
        run: |
          # æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†GitHub Pages
          if curl -s -f "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >/dev/null 2>&1; then
            echo "âœ… GitHub Pageså·²å¯ç”¨ï¼Œé…ç½®æ–‡ä»¶å°†è‡ªåŠ¨éƒ¨ç½²"
            echo "ğŸ“¡ è®¿é—®åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/clash-config.yaml"
          else
            echo "â„¹ï¸ GitHub Pagesæœªå¯ç”¨ï¼Œè¯·åœ¨ä»“åº“è®¾ç½®ä¸­å¯ç”¨ä»¥è·å¾—å…¬å…±è®¿é—®é“¾æ¥"
          fi

      - name: Create deployment summary
        run: |
          echo "## ğŸ“… Clashé…ç½®ç”Ÿæˆå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š ç”Ÿæˆä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ç”Ÿæˆæ—¶é—´ | ${{ steps.generate_config.outputs.generation_time }} |" >> $GITHUB_STEP_SUMMARY
          echo "| é…ç½®å¤§å° | ${{ steps.generate_config.outputs.config_size }} bytes |" >> $GITHUB_STEP_SUMMARY
          echo "| è§¦å‘æ–¹å¼ | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ä»“åº“ | [${{ github.repository }}](https://github.com/${{ github.repository }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“¡ è®¿é—®é“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "- **YAMLé…ç½®**: [clash-config.yaml](https://github.com/${{ github.repository }}/blob/main/public/clash-config.yaml)" >> $GITHUB_STEP_SUMMARY
          echo "- **JSONå…ƒæ•°æ®**: [clash-config.json](https://github.com/${{ github.repository }}/blob/main/public/clash-config.json)" >> $GITHUB_STEP_SUMMARY
          
          if curl -s -f "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >/dev/null 2>&1; then
            echo "- **å…¬å…±è®¿é—®**: [https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/clash-config.yaml](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/clash-config.yaml)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”§ ä½¿ç”¨æ–¹æ³•" >> $GITHUB_STEP_SUMMARY
          echo "1. **Clash for Windows**: åœ¨Profilesé¡µé¢ç‚¹å‡»\"Download from a URL\"" >> $GITHUB_STEP_SUMMARY
          echo "2. **Clash for Android**: åœ¨é…ç½®é¡µé¢æ·»åŠ URLè®¢é˜…" >> $GITHUB_STEP_SUMMARY
          echo "3. **Clash Verge**: åœ¨è®¢é˜…é¡µé¢æ·»åŠ é…ç½®é“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â° æ›´æ–°è®¡åˆ’" >> $GITHUB_STEP_SUMMARY
          echo "- è‡ªåŠ¨æ›´æ–°æ—¶é—´: æ¯æ—¥UTC 18:00ï¼ˆåŒ—äº¬æ—¶é—´02:00ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- æ‰‹åŠ¨è§¦å‘: åœ¨Actionsé¡µé¢è¿è¡Œæ­¤å·¥ä½œæµ" >> $GITHUB_STEP_SUMMARY
          echo "- é…ç½®æ¥æº: åŸºäºæ¯æ—¥IPçº¯å‡€åº¦æ£€æµ‹ç»“æœ" >> $GITHUB_STEP_SUMMARY

  notify-completion:
    needs: generate-clash-config
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'schedule'
    
    steps:
      - name: Send notification
        run: |
          echo "ğŸ“… æ¯æ—¥Clashé…ç½®ç”Ÿæˆä»»åŠ¡å®Œæˆ"
          echo "çŠ¶æ€: ${{ needs.generate-clash-config.result }}"
          echo "æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ å…¶ä»–é€šçŸ¥æ–¹å¼ï¼Œå¦‚Webhookã€é‚®ä»¶ç­‰
