name: ðŸš€ Deploy Cloudflare Pages

on:
  push:
    branches: [main]
    paths:
      - 'public/**'
      - 'functions/**'
      - 'cloudflare/**'
      - 'wrangler.toml'
      - '.github/workflows/deploy-web-interface.yml'
  pull_request:
    branches: [main]
    paths:
      - 'public/**'
      - 'functions/**'
      - 'cloudflare/**'
      - 'wrangler.toml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview
      force_deploy:
        description: 'Force deployment even if no changes detected'
        required: false
        default: false
        type: boolean

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler CLI
        run: npm install -g wrangler

      - name: Validate Cloudflare configuration
        run: |
          # æ£€æŸ¥wrangler.tomlé…ç½®
          if [ -f "wrangler.toml" ]; then
            echo "âœ… wrangler.toml found"
            wrangler whoami || echo "âš ï¸ Not logged in to Cloudflare"
          else
            echo "âŒ wrangler.toml not found"
            exit 1
          fi

      - name: Validate Functions syntax
        run: |
          # æ£€æŸ¥Functionsè¯­æ³•
          if [ -d "functions" ]; then
            echo "âœ… Functions directory found"
            for file in functions/**/*.js; do
              if [ -f "$file" ]; then
                echo "Checking $file..."
                node -c "$file" || echo "âš ï¸ Syntax error in $file"
              fi
            done
          fi

      - name: Validate Worker syntax
        run: |
          # æ£€æŸ¥Workerè¯­æ³•
          if [ -f "cloudflare/scheduled-worker.js" ]; then
            echo "âœ… Worker file found"
            node -c "cloudflare/scheduled-worker.js" || echo "âš ï¸ Syntax error in Worker"
          fi

  # Cloudflare Pageséƒ¨ç½²
  deploy-pages:
    needs: quality-check
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler CLI
        run: npm install -g wrangler

      - name: Deploy to Cloudflare Pages (Preview)
        if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'preview')
        run: |
          wrangler pages deploy public --project-name ip-purity-checker --compatibility-date 2024-01-01
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Deploy to Cloudflare Pages (Production)
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
        run: |
          wrangler pages deploy public --project-name ip-purity-checker --compatibility-date 2024-01-01 --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  # Cloudflare Workerséƒ¨ç½²
  deploy-workers:
    needs: quality-check
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler CLI
        run: npm install -g wrangler

      - name: Deploy Cloudflare Workers
        run: |
          wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  # éƒ¨ç½²åŽæµ‹è¯•
  post-deployment-test:
    needs: [deploy-pages, deploy-workers]
    runs-on: ubuntu-latest
    if: always() && (needs.deploy-pages.result == 'success' || needs.deploy-workers.result == 'success')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Wait for deployment
        run: sleep 60

      - name: Test Cloudflare Pages deployment
        run: |
          # æµ‹è¯•Cloudflare Pageséƒ¨ç½²
          PAGES_URL="https://ip-purity-checker.pages.dev"

          echo "Testing Pages deployment at: $PAGES_URL"

          # æµ‹è¯•é¦–é¡µ
          if curl -f -s "$PAGES_URL" > /dev/null; then
            echo "âœ… Pages homepage test passed"
          else
            echo "âŒ Pages homepage test failed"
          fi

          # æµ‹è¯•è®¢é˜…ç®¡ç†å™¨
          if curl -f -s "$PAGES_URL/subscription-manager.html" > /dev/null; then
            echo "âœ… Subscription manager test passed"
          else
            echo "âŒ Subscription manager test failed"
          fi

          # æµ‹è¯•API Functions
          API_RESPONSE=$(curl -s "$PAGES_URL/api/check-ip?ip=8.8.8.8" || echo "")
          if echo "$API_RESPONSE" | grep -q '"ip"'; then
            echo "âœ… API Functions test passed"
            echo "Response: $API_RESPONSE"
          else
            echo "âš ï¸ API Functions test failed or not ready"
            echo "Response: $API_RESPONSE"
          fi
        continue-on-error: true

      - name: Test Cloudflare Workers deployment
        run: |
          # æ³¨æ„ï¼šWorker URLéœ€è¦æ ¹æ®å®žé™…è´¦æˆ·IDè°ƒæ•´
          echo "âš ï¸ Worker testing requires account-specific URL"
          echo "Please test manually at: https://ip-purity-checker.YOUR_ACCOUNT.workers.dev"
        continue-on-error: true

  # é€šçŸ¥
  notify:
    needs: [deploy-pages, deploy-workers, post-deployment-test]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Cloudflare éƒ¨ç½²æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**éƒ¨ç½²æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy-pages.result }}" == "success" ]; then
            echo "âœ… **Cloudflare Pageséƒ¨ç½²**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ **Pagesè®¿é—®åœ°å€**: https://ip-purity-checker.pages.dev" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Cloudflare Pageséƒ¨ç½²**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.deploy-workers.result }}" == "success" ]; then
            echo "âœ… **Cloudflare Workerséƒ¨ç½²**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "âš™ï¸ **WorkeræœåŠ¡**: å®šæ—¶ä»»åŠ¡å·²éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Cloudflare Workerséƒ¨ç½²**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.post-deployment-test.result }}" == "success" ]; then
            echo "âœ… **éƒ¨ç½²æµ‹è¯•**: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **éƒ¨ç½²æµ‹è¯•**: éƒ¨åˆ†å¤±è´¥æˆ–è·³è¿‡" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ å¯ç”¨åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” å•IPæ£€æµ‹å’Œæ‰¹é‡æ£€æµ‹" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” å®‰å…¨çš„è®¢é˜…é“¾æŽ¥ç®¡ç†" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¡ è®¢é˜…é“¾æŽ¥è§£æžå’Œæ£€æµ‹" >> $GITHUB_STEP_SUMMARY
          echo "- âš™ï¸ æ¯æ—¥è‡ªåŠ¨Clashé…ç½®ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š è¯¦ç»†çš„æ£€æµ‹æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“± å“åº”å¼Webç•Œé¢" >> $GITHUB_STEP_SUMMARY
          echo "- â° å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ£€æµ‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ ä¸‹ä¸€æ­¥æ“ä½œ" >> $GITHUB_STEP_SUMMARY
          echo "1. é…ç½®APIå¯†é’¥: \`wrangler secret put PROXYCHECK_API_KEY\`" >> $GITHUB_STEP_SUMMARY
          echo "2. é…ç½®IPinfo Token: \`wrangler secret put IPINFO_TOKEN\`" >> $GITHUB_STEP_SUMMARY
          echo "3. è®¿é—®è®¢é˜…ç®¡ç†å™¨æ·»åŠ ç§äººè®¢é˜…é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "4. æµ‹è¯•å®šæ—¶ä»»åŠ¡åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
